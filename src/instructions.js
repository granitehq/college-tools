/**
 * Instructions and Help System
 * @version 1.2.1
 * @author College Tools
 * @description Creates comprehensive user instructions and help documentation
 */

/**
 * CollegeTools.Instructions - Instructions and help module
 * Creates and manages the Instructions sheet with comprehensive user guide
 */
var CollegeTools = CollegeTools || {};
CollegeTools.Instructions = (function() {
  'use strict';

  /**
   * Creates or updates the Instructions sheet with comprehensive user guide.
   */
  function createInstructionsSheet() {
    var ss = SpreadsheetApp.getActive();
    var sheet = CollegeTools.Utils.ensureSheet(ss, CollegeTools.Config.SHEET_NAMES.INSTRUCTIONS);
    sheet.clear();

    var row = 1;
    var col = 1;

    // Title Section
    sheet.getRange(row, col).setValue('üéì College Tools - Complete User Guide');
    sheet.getRange(row, col).setFontSize(20).setFontWeight('bold').setBackground('#4285f4').setFontColor('white');
    sheet.getRange(row, col, 1, 6).merge();
    row += 2;

    sheet.getRange(row, col).setValue('Welcome to College Tools! This comprehensive system helps you research, compare, and track your college applications.');
    sheet.getRange(row, col).setFontSize(12).setBackground('#e8f0fe');
    sheet.getRange(row, col, 1, 6).merge();
    row += 3;

    // Quick Start Section
    addSectionHeader(sheet, row, 'üöÄ Quick Start (First Time Setup)');
    row += 2;

    var quickStartSteps = [
      '1. Get your FREE College Scorecard API key (see API Setup section below)',
      '2. Run "üìã Complete Setup (One-Time)" from the College Tools menu',
      '3. Fill out your Personal Profile sheet with your academic info',
      '4. Start adding colleges to research using "Fill current row"',
      '5. Use the trackers to manage your applications and deadlines',
    ];

    quickStartSteps.forEach(function(step) {
      sheet.getRange(row, col).setValue(step);
      sheet.getRange(row, col).setFontSize(11);
      row++;
    });
    row += 2;

    // API Key Section
    addSectionHeader(sheet, row, 'üîë College Scorecard API Setup');
    row += 2;

    var apiInstructions = [
      'üìç What is this? The College Scorecard API provides official government data about colleges.',
      '',
      'üìç How to get your FREE API key:',
      '   1. Visit: https://api.data.gov/signup/',
      '   2. Fill out the simple form (takes 30 seconds)',
      '   3. Check your email for the API key',
      '   4. Copy the key to the "ScorecardAPIKey" sheet',
      '',
      'üìç Where to store it:',
      '   ‚Ä¢ Go to the "ScorecardAPIKey" sheet (tab at bottom)',
      '   ‚Ä¢ Put your API key in cell A1',
      '   ‚Ä¢ Keep this sheet - your key is saved automatically',
      '',
      '‚ö†Ô∏è  Important: Without an API key, you cannot fetch college data!',
    ];

    apiInstructions.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.startsWith('üìç')) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#fff3cd');
      } else if (instruction.startsWith('‚ö†Ô∏è')) {
        sheet.getRange(row, col).setBackground('#f8d7da').setFontColor('#721c24');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Personal Profile Section
    addSectionHeader(sheet, row, 'üìä Your Personal Profile');
    row += 2;

    var profileInstructions = [
      'The Personal Profile sheet is your central hub for academic and financial information.',
      '',
      'üìù Fill out these key sections:',
      '   ‚Ä¢ SAT Score: Your highest composite score',
      '   ‚Ä¢ ACT Score: Your highest composite (optional if you have SAT)',
      '   ‚Ä¢ GPA: Your cumulative unweighted GPA on 4.0 scale',
      '   ‚Ä¢ Family Income: Annual household income (for financial analysis)',
      '   ‚Ä¢ State Residency: Your state (for in-state tuition calculations)',
      '',
      'üí° Pro Tip: This data feeds into ALL your college analysis automatically!',
    ];

    profileInstructions.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.startsWith('üìù') || instruction.startsWith('üí°')) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#d1ecf1');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // College Research Section
    addSectionHeader(sheet, row, 'üèõÔ∏è Researching Colleges');
    row += 2;

    var researchInstructions = [
      '1. Adding Colleges:',
      '   ‚Ä¢ Type college name in Column A of Colleges sheet',
      '   ‚Ä¢ Click "Fill current row" to fetch official data',
      '   ‚Ä¢ Use "Fill current row (fast)" for bulk additions',
      '',
      '2. Available Data:',
      '   ‚Ä¢ Admission rates, costs, graduation rates',
      '   ‚Ä¢ SAT/ACT score ranges',
      '   ‚Ä¢ Earnings after graduation',
      '   ‚Ä¢ Financial aid information',
      '',
      '3. Your Custom Ratings:',
      '   ‚Ä¢ Rate each college 1-5 on factors important to you',
      '   ‚Ä¢ Program Fit, Campus Culture, Research Opportunities, etc.',
      '   ‚Ä¢ Weighted scores calculated automatically',
      '',
      '4. Smart Analysis:',
      '   ‚Ä¢ Admission Chances based on your test scores',
      '   ‚Ä¢ Academic Index Match score (competitiveness)',
      '   ‚Ä¢ Merit Aid Likelihood predictions',
      '   ‚Ä¢ Financial Safety analysis',
    ];

    researchInstructions.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.match(/^\d+\./)) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#e8f0fe');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Menu Guide Section
    addSectionHeader(sheet, row, 'üìã Menu Guide');
    row += 2;

    var menuGuide = [
      'üéì FOR STUDENTS & PARENTS:',
      '   ‚Ä¢ Fill current row: Get data for one college (clean, no setup)',
      '   ‚Ä¢ Fill current row (fast): Quick data fetch with optimizations',
      '   ‚Ä¢ Fill selected rows: Get data for multiple colleges (batch)',
      '   ‚Ä¢ Search College Names: Find colleges by name',
      '',
      'üîß SETUP & CUSTOMIZATION (Run separately as needed):',
      '   ‚Ä¢ Complete Setup (One-Time): Sets up everything you need',
      '   ‚Ä¢ Add/Update Trackers: Create/update all tracking sheets',
      '   ‚Ä¢ Setup Dashboard: Create summary dashboard',
      '   ‚Ä¢ Setup Financial Intelligence: Advanced financial analysis',
      '   ‚Ä¢ Ensure Scoring Formulas: Add/update college scoring',
      '   ‚Ä¢ Enhance: Formats & Dropdowns: Improve sheet appearance',
      '',
      '‚ö° PERFORMANCE & MAINTENANCE:',
      '   ‚Ä¢ Optimize Performance: Clean up and speed up sheets',
      '   ‚Ä¢ Refresh Dashboard Data: Update dashboard calculations',
      '   ‚Ä¢ Fill Regions (all rows): Auto-populate US regions',
      '',
      'üõ†Ô∏è DEVELOPER & DEBUG:',
      '   ‚Ä¢ DEBUG: Fill row (verbose): Detailed diagnostic information',
      '   ‚Ä¢ Show API Quota Status: Check your API usage',
      '   ‚Ä¢ Clear API Cache: Reset cached responses',
      '   ‚Ä¢ Test College Name Validation: Check name matching',
      '   ‚Ä¢ Show version: Current College Tools version',
    ];

    menuGuide.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.startsWith('üéì') || instruction.startsWith('üîß') ||
          instruction.startsWith('‚ö°') || instruction.startsWith('üõ†Ô∏è')) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#d4edda');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Workflow Clarity Section
    addSectionHeader(sheet, row, '‚ö° Workflow: Setup vs Fill Operations');
    row += 2;

    var workflowGuide = [
      'üîÑ CLEAN SEPARATION FOR BETTER PERFORMANCE:',
      '',
      '1Ô∏è‚É£ INITIAL SETUP (Run once or as needed):',
      '   ‚Ä¢ Complete Setup (One-Time) - Creates all sheets and features',
      '   ‚Ä¢ Add/Update Trackers - Updates tracking sheets only',
      '   ‚Ä¢ Setup specific features (Dashboard, Financial, etc.)',
      '',
      '2Ô∏è‚É£ DAILY COLLEGE RESEARCH (Fast & clean):',
      '   ‚Ä¢ Fill current row - Pure data fetching, no setup overhead',
      '   ‚Ä¢ Fill selected rows - Batch data fetching, no setup dialogs',
      '   ‚Ä¢ These operations are now optimized for speed!',
      '',
      'üí° Key Change: Fill operations no longer run tracker setup automatically.',
      '   This eliminates setup dialogs and makes research much faster.',
    ];

    workflowGuide.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.startsWith('üîÑ') || instruction.startsWith('1Ô∏è‚É£') ||
          instruction.startsWith('2Ô∏è‚É£') || instruction.startsWith('üí°')) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#fff3cd');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Tracker Sheets Guide
    addSectionHeader(sheet, row, 'üìä Understanding Your Tracker Sheets');
    row += 2;

    var trackerGuide = [
      'üìà DASHBOARD:',
      '   Your command center with key metrics and progress tracking',
      '',
      'üí∞ FINANCIAL AID TRACKER:',
      '   ‚Ä¢ Track FAFSA, CSS Profile, and scholarship deadlines',
      '   ‚Ä¢ Compare financial aid packages',
      '   ‚Ä¢ Calculate your actual costs and family burden',
      '',
      'üè´ CAMPUS VISIT TRACKER:',
      '   ‚Ä¢ Plan and record campus visits',
      '   ‚Ä¢ Rate your impressions and experiences',
      '   ‚Ä¢ Track follow-up actions',
      '',
      'üìÖ APPLICATION TIMELINE:',
      '   ‚Ä¢ All your deadlines in one place',
      '   ‚Ä¢ Automatic countdown warnings',
      '   ‚Ä¢ Priority levels and completion tracking',
      '',
      'üéì SCHOLARSHIP TRACKER:',
      '   ‚Ä¢ External scholarship opportunities',
      '   ‚Ä¢ Requirements and deadlines',
      '   ‚Ä¢ Application status and awards',
      '',
      '‚úÖ APPLICATION STATUS TRACKER:',
      '   ‚Ä¢ Track your application progress',
      '   ‚Ä¢ Document requirements completion',
      '   ‚Ä¢ Record decisions and outcomes',
    ];

    trackerGuide.forEach(function(instruction) {
      if (instruction === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(instruction);
      if (instruction.match(/^[üìàüí∞üè´üìÖüéì‚úÖ]/)) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#e8f0fe');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Tips and Best Practices
    addSectionHeader(sheet, row, 'üí° Tips & Best Practices');
    row += 2;

    var tips = [
      'üéØ EFFICIENCY TIPS:',
      '   ‚Ä¢ Use "Fill selected rows" to batch process multiple colleges',
      '   ‚Ä¢ Run "Optimize Performance" monthly to keep sheets fast',
      '   ‚Ä¢ Use the Dashboard for quick overview of your progress',
      '',
      'üìä DATA MANAGEMENT:',
      '   ‚Ä¢ Keep your Personal Profile updated - it affects all calculations',
      '   ‚Ä¢ Regularly backup your spreadsheet',
      '   ‚Ä¢ Use consistent college names for best API matching',
      '',
      '‚ö†Ô∏è TROUBLESHOOTING:',
      '   ‚Ä¢ If data won\'t load, check your API key in ScorecardAPIKey sheet',
      '   ‚Ä¢ Use "Clear API Cache" if you get stale data',
      '   ‚Ä¢ Check "Show API Quota Status" if having issues',
      '   ‚Ä¢ Use "DEBUG: Fill row" for detailed error information',
      '',
      'üéì APPLICATION STRATEGY:',
      '   ‚Ä¢ Aim for a balanced list: reach, match, and safety schools',
      '   ‚Ä¢ Use the Academic Index Match to gauge competitiveness',
      '   ‚Ä¢ Pay attention to Financial Safety warnings',
      '   ‚Ä¢ Track all deadlines in the Application Timeline',
    ];

    tips.forEach(function(tip) {
      if (tip === '') {
        row++;
        return;
      }
      sheet.getRange(row, col).setValue(tip);
      if (tip.match(/^[üéØüìä‚ö†Ô∏èüéì]/)) {
        sheet.getRange(row, col).setFontWeight('bold').setBackground('#fff3cd');
      }
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });
    row += 2;

    // Support Section
    addSectionHeader(sheet, row, 'üÜò Getting Help');
    row += 2;

    var supportInfo = [
      'üìù Documentation: This Instructions sheet covers most common questions',
      'üêõ Bug Reports: Report issues at github.com/anthropics/claude-code/issues',
      'üí° Feature Requests: Suggest improvements in the same GitHub repository',
      'üìä Data Questions: College Scorecard data comes from the U.S. Department of Education',
      'üîÑ Updates: Check "Show version" in the menu for your current version',
    ];

    supportInfo.forEach(function(info) {
      sheet.getRange(row, col).setValue(info);
      sheet.getRange(row, col, 1, 6).merge();
      row++;
    });

    // Format the sheet
    sheet.setColumnWidths(1, 6, 150);
    sheet.getRange(1, 1, row, 6).setWrap(true);
    sheet.getRange(1, 1, row, 6).setVerticalAlignment('top');

    // Move Instructions sheet to be first tab
    ss.setActiveSheet(sheet);
    ss.moveActiveSheet(1);

    SpreadsheetApp.getUi().alert('Instructions sheet created! It\'s now your first tab.');
  }

  /**
   * Helper function to add formatted section headers.
   * @param {Sheet} sheet - The sheet to add to
   * @param {number} row - The row number
   * @param {string} title - The section title
   * @private
   */
  function addSectionHeader(sheet, row, title) {
    sheet.getRange(row, 1).setValue(title);
    sheet.getRange(row, 1).setFontSize(14).setFontWeight('bold').setBackground('#34a853').setFontColor('white');
    sheet.getRange(row, 1, 1, 6).merge();
  }

  // Public API
  return {
    createInstructionsSheet: createInstructionsSheet,
  };
})();
